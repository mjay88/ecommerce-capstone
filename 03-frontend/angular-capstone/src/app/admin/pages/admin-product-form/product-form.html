<div class="main-content">
  <div class="section-content section-content-p30">
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0">
          @if (editMode) {
            Edit Product
          } @else {
            New Product
          }
        </h2>

        <button
          class="btn btn-outline-secondary"
          (click)="cancel()"
          [disabled]="saving || uploading"
        >
          Back to Products
        </button>
      </div>

      @if (loading) {
        <div class="alert alert-info">Loading…</div>
      }

      @if (errorMsg) {
        <div class="alert alert-danger">{{ errorMsg }}</div>
      }
      @if (successMsg) {
        <div class="alert alert-success">{{ successMsg }}</div>
      }

      <form [formGroup]="productForm" (ngSubmit)="save()" class="card p-3">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Name</label>
            <input class="form-control" formControlName="name" />
            @if (productForm.get('name')?.touched && productForm.get('name')?.invalid) {
              <div class="text-danger small mt-1">Name is required.</div>
            }
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Category</label>
            <select class="form-select" formControlName="categoryId">
              <option [ngValue]="null">Select a category…</option>
              @for (c of categories; track c.id) {
                <option [ngValue]="c.id">{{ c.categoryName }}</option>
              }
            </select>
            @if (productForm.get('categoryId')?.touched && productForm.get('categoryId')?.invalid) {
              <div class="text-danger small mt-1">Category is required.</div>
            }
          </div>

          <div class="col-12">
            <label class="form-label">Description</label>
            <textarea class="form-control" rows="4" formControlName="description"></textarea>
            @if (
              productForm.get('description')?.touched && productForm.get('description')?.invalid
            ) {
              <div class="text-danger small mt-1">Description is required.</div>
            }
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Unit Price</label>
            <input type="number" step="0.01" class="form-control" formControlName="unitPrice" />
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Units In Stock</label>
            <input type="number" class="form-control" formControlName="unitsInStock" />
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">SKU (optional)</label>
            <input class="form-control" formControlName="sku" />
          </div>

          <div class="col-12 col-md-3 d-flex align-items-end">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                formControlName="active"
                id="activeCheck"
              />
              <label class="form-check-label" for="activeCheck">Active</label>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">Product Image</label>
          <input
            type="file"
            class="form-control"
            accept="image/*"
            (change)="onFileSelected($event)"
          />
          @if (selectedFile) {
            <div class="text-muted small mt-1">Selected: {{ selectedFile.name }}</div>
          }
          @if (!selectedFile && !existingImageUrl && !(saving || uploading)) {
            <div class="text-danger small mt-1">Image is required to save.</div>
          }
        </div>

        <div class="d-flex gap-2 mt-3">
          <button
            class="btn btn-primary"
            type="submit"
            [disabled]="saving || uploading || (!selectedFile && !existingImageUrl)"
          >
            @if (saving || uploading) {
              Saving…
            } @else {
              Save
            }
          </button>

          <button
            class="btn btn-outline-secondary"
            type="button"
            (click)="cancel()"
            [disabled]="saving || uploading"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
